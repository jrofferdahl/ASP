name: Push to Apps Script & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Configure clasp credentials
        run: |
          if [ -z "${{ secrets.CLASPRC_JSON }}" ]; then
            echo "Missing CLASPRC_JSON secret; aborting."
            exit 1
          fi
          mkdir -p "$HOME"
          # If the secret looks like raw JSON (starts with '{'), write it directly. Otherwise assume base64 and decode.
          if echo "${{ secrets.CLASPRC_JSON }}" | head -c 1 | grep -q '{'; then
            printf "%s" "${{ secrets.CLASPRC_JSON }}" > "$HOME/.clasprc.json"
          else
            printf "%s" "${{ secrets.CLASPRC_JSON }}" | base64 --decode > "$HOME/.clasprc.json"
          fi
          chmod 600 "$HOME/.clasprc.json"
          echo "Wrote $HOME/.clasprc.json (first 3 lines):"
          sed -n '1,3p' "$HOME/.clasprc.json" || true

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Validate clasp auth
        run: |
          # Run a harmless clasp command to validate that clasp can read the credentials
          clasp list || true

      - name: Push code to Apps Script
        run: |
          if [ ! -f .clasp.json ]; then
            echo ".clasp.json not found. Ensure your project has .clasp.json with scriptId."
            exit 1
          fi
          clasp push --force

      - name: Create version and deploy
        run: |
          VERSION_OUTPUT="$(clasp version -m "CI: ${GITHUB_SHA}")"
          echo "version output: $VERSION_OUTPUT"
          VERSION_NUMBER="$(echo "$VERSION_OUTPUT" | awk '{print $NF}')"
          clasp deploy --versionNumber "$VERSION_NUMBER" --description "CI deploy from ${GITHUB_REF}"

      - name: Success notice
        run: echo "Completed."
