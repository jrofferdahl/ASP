name: Deploy Apps Script via clasp
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Restore clasp credentials to $HOME/.clasprc.json
        # bind the secret into the step environment (safe â€” Actions writes it to the runner env file)
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          # write the secret from the environment variable into the file safely
          printf '%s' "$CLASPRC_JSON" > "$HOME/.clasprc.json"
          # If your secret is base64-encoded, instead use:
          # echo "$CLASPRC_JSON" | base64 --decode > "$HOME/.clasprc.json"
          chmod 600 "$HOME/.clasprc.json"
          ls -l "$HOME/.clasprc.json"
          wc -c "$HOME/.clasprc.json"
        shell: bash

      - name: "Debug restored credentials (safe: prints only existence and JSON keys)"
        run: |
          echo "HOME=$HOME"
          echo "File exists: $( [ -f \"$HOME/.clasprc.json\" ] && echo yes || echo no )"
          echo "File size (bytes): $( [ -f \"$HOME/.clasprc.json\" ] && wc -c < \"$HOME/.clasprc.json\" || echo 0 )"
          # print only the top-level JSON property names to confirm format (won't reveal secret values)
          python3 - <<'PY'
          import json, os, sys
          fp = os.path.expanduser("~/.clasprc.json")
          if not os.path.exists(fp):
              print("JSON file not found")
              sys.exit(0)
          try:
              with open(fp) as f:
                  data = json.load(f)
              print("top-level keys:", list(data.keys()))
          except Exception as e:
              print("error parsing json:", e)
          PY
        shell: bash

      - name: Install dependencies (if any)
        run: npm ci || true

      - name: Push to Apps Script
        env:
          HOME: /home/runner
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          echo "Using HOME=$HOME; listing ~/.clasprc.json"
          ls -l "$HOME/.clasprc.json" || true
          clasp --version || true
          # show which account (if any) clasp is logged in as
          clasp whoami || echo "clasp not logged in or credentials invalid"
          # push (no --verbose flag; clasp doesn't support it)
          clasp push --force
        shell: bash
