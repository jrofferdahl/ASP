name: Deploy Apps Script via clasp
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Restore clasp credentials to $HOME/.clasprc.json
        # bind the secret into the step environment (safe â€” Actions writes it to the runner env file)
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          # write the secret from the environment variable into the file safely
          printf '%s' "$CLASPRC_JSON" > "$HOME/.clasprc.json"
          # If your secret is base64-encoded, instead use:
          # echo "$CLASPRC_JSON" | base64 --decode > "$HOME/.clasprc.json"
          chmod 600 "$HOME/.clasprc.json"
          ls -l "$HOME/.clasprc.json"
          wc -c "$HOME/.clasprc.json"
        shell: bash

      - name: "Debug restored credentials (safe: checks for token keys without printing secrets)"
        run: |
          echo "HOME=$HOME"
          echo "File exists: $( [ -f \"$HOME/.clasprc.json\" ] && echo yes || echo no )"
          echo "File size (bytes): $( [ -f \"$HOME/.clasprc.json\" ] && wc -c < \"$HOME/.clasprc.json\" || echo 0 )"
          python3 - <<'PY'
          import json, os, sys
          fp = os.path.expanduser("~/.clasprc.json")
          if not os.path.exists(fp):
              print("JSON file not found")
              sys.exit(0)
          try:
              with open(fp, 'r') as f:
                  data = json.load(f)
          except Exception as e:
              print("error parsing json:", e)
              sys.exit(0)

          def find_keys(obj, key):
              if isinstance(obj, dict):
                  for k, v in obj.items():
                      if k == key:
                          return True
                      if find_keys(v, key):
                          return True
              elif isinstance(obj, list):
                  for item in obj:
                      if find_keys(item, key):
                          return True
              return False

          has_access_token = find_keys(data, 'access_token')
          has_refresh_token = find_keys(data, 'refresh_token')
          print('has_access_token:', has_access_token)
          print('has_refresh_token:', has_refresh_token)
          print('top-level keys:', list(data.keys()))
          PY
        shell: bash

      - name: Install dependencies (if any)
        run: npm ci || true

      - name: Push to Apps Script
        env:
          HOME: /home/runner
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          echo "Using HOME=$HOME; listing ~/.clasprc.json"
          ls -l "$HOME/.clasprc.json" || true
          clasp --version || true
          # clasp whoami not available in this clasp version; rely on the JSON checks above
          clasp push --force
        shell: bash
