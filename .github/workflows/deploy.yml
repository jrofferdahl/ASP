name: Deploy Apps Script via clasp
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Restore clasp credentials to $HOME/.clasprc.json
        # bind the secret into the step environment (safe â€” Actions writes it to the runner env file)
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          # write the secret from the environment variable into the file safely
          printf '%s' "$CLASPRC_JSON" > "$HOME/.clasprc.json"
          chmod 600 "$HOME/.clasprc.json"
          ls -l "$HOME/.clasprc.json"
          wc -c "$HOME/.clasprc.json"
        shell: bash

      - name: "Debug restored credentials (safe: prints only existence and JSON keys)"
        run: |
          echo "HOME=$HOME"
          echo "File exists: $( [ -f "$HOME/.clasprc.json" ] && echo yes || echo no )"
          echo "File size (bytes): $( [ -f "$HOME/.clasprc.json" ] && wc -c < "$HOME/.clasprc.json" || echo 0 )"
          # print only the top-level JSON property names to confirm format (won't reveal secret values)
          python3 - <<'PY'
          import json, os, sys
          fp = os.path.expanduser("~/.clasprc.json")
          if not os.path.exists(fp):
              print("JSON file not found")
              sys.exit(0)
          try:
              data = json.load(open(fp))
              print("top-level keys:", list(data.keys()))
          except Exception as e:
              print("error parsing json:", e)
          PY
        shell: bash

      - name: Install dependencies (if any)
        run: npm ci || true

      - name: Push to Apps Script
        # ensure HOME is set so clasp looks in the same place we wrote the file
        env:
          HOME: /home/runner
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          echo "Using HOME=$HOME; listing ~/.clasprc.json"
          ls -l "$HOME/.clasprc.json" || true
          clasp --version || true
          # run clasp with debug/verbose to get more output if it still fails
          clasp push --force --verbose
        shell: bash
