name: Deploy Apps Script via clasp
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Restore clasp credentials
        # write the secret into the runner user's home so clasp will pick it up
        run: printf '%s\n' "${{ secrets.CLASPRC_JSON }}" > $HOME/.clasprc.json
        shell: bash

      - name: "Debug restored credentials (safe: prints only existence and JSON keys)"
        run: |
          echo "HOME=$HOME"
          echo "File exists: $( [ -f "$HOME/.clasprc.json" ] && echo yes || echo no )"
          echo "File size (bytes): $( [ -f "$HOME/.clasprc.json" ] && wc -c < "$HOME/.clasprc.json" || echo 0 )"
          # print only the top-level JSON property names to confirm format (won't reveal secret values)
          python3 - <<'PY'
          import json,os,sys
          fp = os.path.expanduser("~/.clasprc.json")
          if not os.path.exists(fp):
              print("JSON file not found")
              sys.exit(0)
          try:
              data = json.load(open(fp))
              print("top-level keys:", list(data.keys()))
          except Exception as e:
              print("error parsing json:", e)
          PY
        shell: bash

      - name: Install dependencies (if any)
        run: npm ci || true

      - name: Push to Apps Script
        # expose the secret as env variable as an alternate credential source
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: clasp push --force
        shell: bash
